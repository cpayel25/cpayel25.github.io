<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Narrative Visualization</title>
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- CSS Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #505143; /* Set font color */
            background-color: #9C9E84; /* Set background color */
        }
        #visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            width: 100%;
            margin: 0 auto;
            justify-items: center;
        }
        h1 {
            font-size: 50px; /* Increase font size */
            font-weight: bold; /* Make font bold */
            text-align: center; /* Center align the header */
        }
        .legend {
            font-size: 14px;
        }
        #legend1, #legend2 {
            text-align: center;
            margin-top: 20px;
        }
        .button-container {
            text-align: center;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        .bar text {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }
        .bar text.vertical {
            transform: rotate(-90deg);
            transform-origin: middle;
            text-anchor: start;
        }
    </style>
</head>
<body>
    <h1>Overview of Covid cases and deaths between March 2020 till the end of March 2021</h1>

    <div id="scene1">
        <div id="visualization">
            <div id="chart1">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart2">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div id="legend1">
            <svg width="1200" height="100"></svg>
        </div>
        <div class="button-container">
            <button id="next">Next</button>
        </div>
    </div>

    <div id="scene2" class="hidden">
        <div id="visualization">
            <div id="chart3">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart4">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div class="button-container">
            <button id="previous">Previous</button>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        async function init() {
            // Load the data
            const data = await d3.csv('./facilities.csv');

            const aggregatedCasesData = d3.rollup(
                data,
                v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per state
                d => d.facility_state
            );
            const aggregatedDeathsData = d3.rollup(
                data,
                v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate deaths per state
                d => d.facility_state
            );

            // Convert the Map to an array for easier handling in D3
            const aggregatedCasesArray = Array.from(aggregatedCasesData, ([facility_state, total_inmate_cases]) => ({facility_state, total_inmate_cases}));
            const aggregatedDeathsArray = Array.from(aggregatedDeathsData, ([facility_state, total_inmate_deaths]) => ({facility_state, total_inmate_deaths}));

            // Sort the aggregated array by total inmate cases and deaths in descending order
            aggregatedCasesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
            aggregatedDeathsArray.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);

            // Get top 5 states
            const top5CasesArray = aggregatedCasesArray.slice(0, 5);
            const top5DeathsArray = aggregatedDeathsArray.slice(0, 5);

            // Define dimensions and margins
            const margin = {top: 20, right: 150, bottom: 40, left: 90},
                  width = 600 - margin.left - margin.right,
                  height = 500 - margin.top - margin.bottom;

            const allStates = [...new Set(aggregatedDeathsArray.map(d => d.facility_state).concat(aggregatedCasesArray.map(d => d.facility_state)))];
            const color = d3.scaleOrdinal()
                            .domain(allStates)
                            .range(d3.schemeCategory10);

            const top5Color = d3.scaleOrdinal()
                                .domain(top5CasesArray.map(d => d.facility_state))
                                .range(d3.schemeCategory10);

            // Function to create bar charts
            function createBarChart(svgSelector, data, yValue, yText, includeLabels = false) {
                const svg = d3.select(svgSelector)
                              .attr("width", width + margin.left + margin.right)
                              .attr("height", height + margin.top + margin.bottom)
                              .append("g")
                              .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                            .domain(data.map(d => d.facility_state))
                            .range([0, width])
                            .padding(0.1);
                
                const y = d3.scaleLinear()
                            .domain([0, d3.max(data, yValue)])
                            .nice() // To round the domain values
                            .range([height, 0]);

                // Add the y axis
                svg.append("g")
                   .call(d3.axisLeft(y));

                // Add the y axis title
                svg.append("text")
                   .attr("transform", "rotate(-90)")
                   .attr("x", -height / 2)
                   .attr("y", -margin.left + 20)
                   .attr("text-anchor", "middle")
                   .text(yText);

                // Add the x axis
                svg.append("g")
                   .attr("transform", `translate(0,${height})`)
                   .call(d3.axisBottom(x).tickSize(0).tickFormat(''));

                // Create bars
                const bars = svg.selectAll(".bar")
                   .data(data)
                   .enter()
                   .append("rect")
                   .attr("class", "bar")
                   .attr("x", d => x(d.facility_state))
                   .attr("y", d => y(yValue(d)))
                   .attr("width", x.bandwidth())
                   .attr("height", d => height - y(yValue(d)))
                   .attr("fill", d => (includeLabels ? top5Color(d.facility_state) : color(d.facility_state)));

                if (includeLabels) {
                    // Add state names inside bars with adjustments
                    svg.selectAll(".bar-label")
                       .data(data)
                       .enter()
                       .append("text")
                       .attr("class", "bar-label")
                       .attr("x", d => x(d.facility_state) + x.bandwidth() / 2)
                       .attr("y", d => y(yValue(d)) + (height - y(yValue(d))) / 2)
                       .attr("dy", ".35em")
                       .style("text-anchor", "middle")
                       .style("dominant-baseline", "middle") // Vertically center the text
                       .text(d => d.facility_state);
                }
            }

            // Function to create legends
            function createLegend(svgSelector, colorScale, legendTitle) {
                const svg = d3.select(svgSelector);
                
                const legendItemWidth = 100; // Adjust this value based on the width you want for each legend item
                const itemsPerRow = Math.floor(1200 / legendItemWidth);

                const legend = svg.selectAll(".legend")
                                  .data(colorScale.domain())
                                  .enter().append("g")
                                  .attr("class", "legend")
                                  .attr("transform", (d, i) => {
                                      const x = (i % itemsPerRow) * legendItemWidth;
                                      const y = Math.floor(i / itemsPerRow) * 20; // 20 pixels height per row
                                      return `translate(${x}, ${y})`;
                                  });

                legend.append("rect")
                      .attr("width", 18)
                      .attr("height", 18)
                      .style("fill", colorScale);

                legend.append("text")
                      .attr("x", 24)
                      .attr("y", 9)
                      .attr("dy", ".35em")
                      .style("text-anchor", "start")
                      .text(d => d);
            }

            // Create the SVG containers and bar charts
            createBarChart("#chart1 svg", aggregatedCasesArray, d => d.total_inmate_cases, "Total Inmate Cases");
            createBarChart("#chart2 svg", aggregatedDeathsArray, d => d.total_inmate_deaths, "Total Inmate Deaths");

            createBarChart("#chart3 svg", top5CasesArray, d => d.total_inmate_cases, "Top 5 States for Inmate Cases", true);
            createBarChart("#chart4 svg", top5DeathsArray, d => d.total_inmate_deaths, "Top 5 States for Inmate Deaths", true);

            // Add legends
            createLegend("#legend1 svg", color, "Legend");
        }

        init();

        document.getElementById('next').addEventListener('click', function() {
            document.getElementById('scene1').classList.add('hidden');
            document.getElementById('scene2').classList.remove('hidden');
        });

        document.getElementById('previous').addEventListener('click', function() {
            document.getElementById('scene2').classList.add('hidden');
            document.getElementById('scene1').classList.remove('hidden');
        });
    </script>
</body>
</html>
