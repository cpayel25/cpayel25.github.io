<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Narrative Visualization</title>
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- D3-Annotation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <!-- CSS Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #505143; /* Set font color */
            background-color: #9C9E84; /* Set background color */
        }
        #visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            width: 100%;
            margin: 0 auto;
            justify-items: center;
        }
        h1 {
            font-size: 50px; /* Increase font size */
            font-weight: bold; /* Make font bold */
            text-align: center; /* Center align the header */
        }
        .legend {
            font-size: 14px;
        }
        #legend1, #legend2, #legend3 {
            text-align: center;
            margin-top: 20px;
        }
        .button-container {
            text-align: center;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #505143; /* Set button background color to match header */
            color: white; /* Set button font color to white */
            border: none; /* Remove default border */
            border-radius: 5px; /* Optional: Add rounded corners */
        }
        button:hover {
            background-color: #7F815C; /* Optional: Add a hover effect */
        }
        .hidden {
            display: none;
        }
        .bar text {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }
        .bar text.vertical {
            transform: rotate(-90deg);
            transform-origin: middle;
            text-anchor: start;
        }
        #dropdown-menu {
            text-align: center;
            margin-top: 20px;
        }

        #view-selection {
    padding: 10px;
    font-size: 16px;
    background-color: #505143; /* Set background color for the dropdown */
    color: white; /* Set font color for the dropdown */
    border: none; /* Remove default border */
    border-radius: 5px; /* Optional: Add rounded corners */
}
        select {
            padding: 10px;
            font-size: 16px;
        }
        .annotation-note {
        fill: black; /* Change text color here */
        font-size: 16px; /* Optional: Change font size */
        font-weight: bold; /* Optional: Change font weight */
    }

    .annotation-title {
        fill: black; /* Change title color here */
        font-weight: bold; /* Optional: Change font weight */
    }
    #footnote {
    font-size: 16px;
    color: #505143;
    text-align: right;
    margin: 10px;
    padding-right: 10px;
    position: fixed;
    right: 0;
    bottom: 0;
    
}
.caption {
            font-size: 16px;
            color: #505143;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Overview of Covid cases and deaths between March 2020 till the end of March 2021</h1>

    <div id="scene1">
        <div id="visualization">
            <div id="chart1">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart2">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div id="legend1">
            <svg width="1200" height="100"></svg>
        </div>
        <div class="button-container">
            <button id="next1">Next</button>
        </div>
        <div id="caption1" class="caption">
            Per US State, correlation between Covid cases and deaths in inmates and Covid cases in Officers and inmates.
Data source: https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv
Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <div id="scene2" class="hidden">
        <div id="visualization">
            <div id="chart3">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart4">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div class="button-container">
            <button id="previous2">Previous</button>
            <button id="next2">Next</button>
        </div>
        <div id="legend2">
            <svg width="1200" height="100"></svg>
        </div>
        <div id="caption1" class="caption">
            Per US State, correlation between Covid cases and deaths in inmates and Covid cases in Officers and inmates.
Data source: https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv
Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <div id="scene3" class="hidden">
        <div id="dropdown-menu">
            <label for="view-selection">Select States View: </label>
            <select id="view-selection">
                <option value="top5">Top 5 States</option>
                <option value="all">All States</option>
            </select>
        </div>
        <div id="visualization">
            <div id="chart5">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart6">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div id="legend3">
            <svg width="1200" height="100"></svg>
        </div>
        <div class="button-container">
            <button id="previous3">Previous</button>
        </div>
        <div id="caption1" class="caption">
            Per US State, correlation between Covid cases and deaths in inmates and Covid cases in Officers and inmates.
Data source: https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv
Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        async function init() {
            // Load the data
            const data = await d3.csv('./facilities.csv');
        /*function wrapText(text, width) {
            text.each(function() {
            const text = d3.select(this);
            let words = text.text().split(/\s+/).reverse();
            let word;
            let line = [];
            let lineNumber = 0;
            const lineHeight = 1.1; // ems
            const y = text.attr("y");
            const x = text.attr("x");
            const dy = parseFloat(text.attr("dy") || 0);
            let tspan = text.text(null)
                .append("tspan")
                .attr("x", x)
                .attr("y", y)
                .attr("dy", dy + "em");

            while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    tspan = text.append("tspan")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("dy", ++lineNumber * lineHeight + dy + "em")
                        .text(word);
                }
            }
        });
    }*/

            const aggregatedCasesData = d3.rollup(
                data,
                v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per state
                d => d.facility_state
            );
            const aggregatedDeathsData = d3.rollup(
                data,
                v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate deaths per state
                d => d.facility_state
            );

            // Convert the Map to an array for easier handling in D3
            const aggregatedCasesArray = Array.from(aggregatedCasesData, ([facility_state, total_inmate_cases]) => ({facility_state, total_inmate_cases}));
            const aggregatedDeathsArray = Array.from(aggregatedDeathsData, ([facility_state, total_inmate_deaths]) => ({facility_state, total_inmate_deaths}));

            // Sort the aggregated array by total inmate cases and deaths in descending order
            aggregatedCasesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
            aggregatedDeathsArray.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);

            // Get top 5 states
            const top5CasesArray = aggregatedCasesArray.slice(0, 5);
            const top5DeathsArray = aggregatedDeathsArray.slice(0, 5);

            // Define dimensions and margins
            const margin = {top: 20, right: 150, bottom: 40, left: 90},
                  width = 600 - margin.left - margin.right,
                  height = 500 - margin.top - margin.bottom;

            const allStates = [...new Set(aggregatedDeathsArray.map(d => d.facility_state).concat(aggregatedCasesArray.map(d => d.facility_state)))];
            const color = d3.scaleOrdinal()
                            .domain(allStates)
                            .range(d3.schemeCategory10);

            const top5Color = d3.scaleOrdinal()
                                .domain(top5CasesArray.map(d => d.facility_state))
                                .range(d3.schemeCategory10);

            // Function to create bar charts
            function createBarChart(svgSelector, data, yValue, yText, includeLabels = false, annotations = [], color = d3.scaleOrdinal(d3.schemeCategory10)) {
                const svg = d3.select(svgSelector)
                              .attr("width", width + margin.left + margin.right)
                              .attr("height", height + margin.top + margin.bottom)
                              .append("g")
                              .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                            .domain(data.map(d => d.facility_state))
                            .range([0, width])
                            .padding(0.1);
                
                const y = d3.scaleLinear()
                            .domain([0, d3.max(data, yValue)])
                            .nice() // To round the domain values
                            .range([height, 0]);

                // Add the y axis
                svg.append("g")
                   .call(d3.axisLeft(y));

                // Add the y axis title
                svg.append("text")
                   .attr("transform", "rotate(-90)")
                   .attr("x", -height / 2)
                   .attr("y", -margin.left + 20)
                   .attr("text-anchor", "middle")
                   .text(yText);

                // Add the x axis
                svg.append("g")
                   .attr("transform", `translate(0,${height})`)
                   .call(d3.axisBottom(x).tickSize(0).tickFormat(''));

                // Create bars
                svg.selectAll(".bar")
                   .data(data)
                   .enter()
                   .append("rect")
                   .attr("class", "bar")
                   .attr("x", d => x(d.facility_state))
                   .attr("y", d => y(yValue(d)))
                   .attr("width", x.bandwidth())
                   .attr("height", d => height - y(yValue(d)))
                   .attr("fill", d => (includeLabels ? top5Color(d.facility_state) : color(d.facility_state)));

                if (includeLabels) {
                    // Add state names inside bars with adjustments
                    svg.selectAll(".bar-label")
                       .data(data)
                       .enter()
                       .append("text")
                       .attr("class", "bar-label")
                       .attr("x", d => x(d.facility_state) + x.bandwidth() / 2)
                       .attr("y", d => y(yValue(d)) + (height - y(yValue(d))) / 2)
                       .attr("dy", ".35em")
                       .style("text-anchor", "middle")
                       .style("dominant-baseline", "middle") // Vertically center the text
                       .text(d => d.facility_state);
                }

                // Add annotations if provided
                if (annotations.length > 0) {
                    const makeAnnotations = d3.annotation()
                                              .annotations(annotations)
                                              .type(d3.annotationLabel);

                    svg.append("g")
                       .attr("class", "annotation-group")
                       .call(makeAnnotations);
                    /*svg.selectAll(".annotation-note-label")
                       .call(wrapText, 100); // Adjust width as needed
                       */
                       svg.selectAll(".annotation-note-label")
   .style("fill", "black") // Set fill color directly
   .style("font-size", "16px") // Ensure font size
   .style("font-weight", "bold"); // Ensure font weight

svg.selectAll(".annotation-title-label")
   .style("fill", "black") // Set fill color directly
   .style("font-weight", "bold"); // Ensure font weight
                }
            }
            
            // Function to create legends
            function createLegend(svgSelector, colorScale, legendTitle) {
                const svg = d3.select(svgSelector);
                
                const legendItemWidth = 100; // Adjust this value based on the width you want for each legend item
                const itemsPerRow = Math.floor(1200 / legendItemWidth);

                const legend = svg.selectAll(".legend")
                                  .data(colorScale.domain())
                                  .enter().append("g")
                                  .attr("class", "legend")
                                  .attr("transform", (d, i) => {
                                      const x = (i % itemsPerRow) * legendItemWidth;
                                      const y = Math.floor(i / itemsPerRow) * 20; // 20 pixels height per row
                                      return `translate(${x}, ${y})`;
                                  });

                legend.append("rect")
                      .attr("width", 18)
                      .attr("height", 18)
                      .style("fill", colorScale);

                legend.append("text")
                      .attr("x", 24)
                      .attr("y", 9)
                      .attr("dy", ".35em")
                      .style("text-anchor", "start")
                      .text(d => d);
            }

            // Define annotations
            const annotationsCasesTop5 = [
                {
                    note: {
                        label: "Top 5 states with highest number of Covid Cases among inmates"
                    },
                    x: 20, // Adjust these values based on your data and chart dimensions
                    y: 50,
                    dy: -50,
                    dx: -10,
                    //className: "annotation-note",  // Add custom class
                    //titleClassName: "annotation-title", // Add custom title class
                    subject: { // Custom subject to hide the connector line
            type: d3.annotationLabel,
                                x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                    y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                    dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                    dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
        }
                    
                }
            ];

            const annotationsDeathsTop5 = [
                {
                    note: {
                        label: "Top 5 states with highest number of Covid Deaths among inmates"
                    },
                    x: 80, // Adjust these values based on your data and chart dimensions
                    y: 40,
                    dy: -50,
                    dx: -80,
                    //className: "annotation-note",  // Add custom class
                    //titleClassName: "annotation-title", // Add custom title class
                    //subject: { radius: 30 }
                    subject: { // Custom subject to hide the connector line
            type: d3.annotationLabel,
            x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                    y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                    dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                    dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
        }
                    
                }
            ];

            const annotationsCases = [
                {
                    note: {
                        label: "All US states and the number of their Covid Cases among inmates"
                    },
                    x: 60, // Adjust these values based on your data and chart dimensions
                    y: 150,
                    dy: -50,
                    dx: 50,
                    //className: "annotation-note",  // Add custom class
                    //titleClassName: "annotation-title", // Add custom title class
                    //subject: { radius: 30 }
                    subject: { // Custom subject to hide the connector line

                    type: d3.annotationLabel, // Ensure this type is correct
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                    y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                    dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                    dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
        }
                }
            ];

            const annotationsDeaths = [
                {
                    note: {
                        label: "All US states and the number of their Covid deaths among inmates"
                    },
                    x: 60, // Adjust these values based on your data and chart dimensions
                    y: 150,
                    dy: -50,
                    dx: 50,
                    //className: "annotation-note",  // Add custom class
                    //titleClassName: "annotation-title", // Add custom title class
                    //subject: { radius: 30 }
                    subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel, // Ensure this type is correct
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                    y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                    dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                    dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
        }
                }
            ];

            // Create bar charts for scenes 1 and 2
            createBarChart("#chart1 svg", aggregatedCasesArray, d => d.total_inmate_cases, "Total Inmate Cases", false, annotationsCases);
            createBarChart("#chart2 svg", aggregatedDeathsArray, d => d.total_inmate_deaths, "Total Inmate Deaths", false, annotationsDeaths);
            createLegend("#legend1 svg", color, "States");

            createBarChart("#chart3 svg", top5CasesArray, d => d.total_inmate_cases, "Total Inmate Cases", true, annotationsCasesTop5);
            createBarChart("#chart4 svg", top5DeathsArray, d => d.total_inmate_deaths, "Total Inmate Deaths", true, annotationsDeathsTop5);
            createLegend("#legend2 svg", top5Color, "Top 5 States");

            // Create bar charts for scene 3 based on selection
            function updateScene3(view) {
                d3.select("#chart5 svg").selectAll("*").remove();
                d3.select("#chart6 svg").selectAll("*").remove();
                d3.select("#legend3 svg").selectAll("*").remove();
                
                if (view === "top5") {
                    createBarChart("#chart5 svg", top5CasesArray, d => d.total_inmate_cases, "Total Inmate Cases", true, annotationsCasesTop5);
                    createBarChart("#chart6 svg", top5DeathsArray, d => d.total_inmate_deaths, "Total Inmate Deaths", true, annotationsDeathsTop5);
                    createLegend("#legend3 svg", top5Color, "Top 5 States");
                } else {
                    createBarChart("#chart5 svg", aggregatedCasesArray, d => d.total_inmate_cases, "Total Inmate Cases", false, annotationsCases);
                    createBarChart("#chart6 svg", aggregatedDeathsArray, d => d.total_inmate_deaths, "Total Inmate Deaths", false, annotationsDeaths);
                    createLegend("#legend3 svg", color, "States");
                }
            }

            // Initial setup for scene 3
            updateScene3("top5");

            // Handle scene navigation
            document.getElementById("next1").onclick = function() {
                document.getElementById("scene1").classList.add("hidden");
                document.getElementById("scene2").classList.remove("hidden");
            };

            document.getElementById("previous2").onclick = function() {
                document.getElementById("scene2").classList.add("hidden");
                document.getElementById("scene1").classList.remove("hidden");
            };

            document.getElementById("next2").onclick = function() {
                document.getElementById("scene2").classList.add("hidden");
                document.getElementById("scene3").classList.remove("hidden");
            };

            document.getElementById("previous3").onclick = function() {
                document.getElementById("scene3").classList.add("hidden");
                document.getElementById("scene2").classList.remove("hidden");
            };

            // Handle drop-down menu selection
            document.getElementById("view-selection").onchange = function() {
                updateScene3(this.value);
            };
        }

        // Initialize the visualization
        init();
    </script>
</body>
</html>
