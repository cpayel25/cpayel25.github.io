<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Narrative Visualization</title>
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- CSS Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #505143; /* Set font color */
            background-color: #9C9E84; /* Set background color */
        }
        #visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            width: 100%;
            margin: 0 auto;
            justify-items: center;
        }
        h1 {
            font-size: 50px; /* Increase font size */
            font-weight: bold; /* Make font bold */
            text-align: center; /* Center align the header */
        }
        .legend {
            font-size: 14px;
        }
        #legend {
            grid-column: span 2;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Overview of Covid cases and deaths between March 2020 till the end of March 2021</h1>
    <div id="visualization">
        <div id="chart1">
            <svg width="600" height="500"></svg>
        </div>
        <div id="chart2">
            <svg width="600" height="500"></svg>
        </div>
        <div id="legend">
            <svg width="1200" height="100"></svg>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        async function init() {
            // Load the data
            const data = await d3.csv('./facilities.csv');

            const aggregatedCasesData = d3.rollup(
                data,
                v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per state
                d => d.facility_state
            );
            const aggregatedDeathsData = d3.rollup(
                data,
                v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate deaths per state
                d => d.facility_state
            );
            // Convert the Map to an array for easier handling in D3
            const aggregatedCasesArray = Array.from(aggregatedCasesData, ([facility_state, total_inmate_cases]) => ({facility_state, total_inmate_cases}));
            const aggregatedDeathsArray = Array.from(aggregatedDeathsData, ([facility_state, total_inmate_deaths]) => ({facility_state, total_inmate_deaths}));

            // Sort the aggregated array by total inmate cases and deaths in descending order
            aggregatedCasesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
            aggregatedDeathsArray.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);

            // Define dimensions and margins
            const margin = {top: 20, right: 150, bottom: 40, left: 90},
                  width = 600 - margin.left - margin.right,
                  height = 500 - margin.top - margin.bottom;

            const allStates = [...new Set(aggregatedDeathsArray.map(d => d.facility_state).concat(aggregatedCasesArray.map(d => d.facility_state)))];
            const color = d3.scaleOrdinal()
                            .domain(allStates)
                            .range(d3.schemeCategory10);
            // Create the SVG container for inmate cases
            const svg1 = d3.select("#chart1 svg")
                          .attr("width", width + margin.left + margin.right)
                          .attr("height", height + margin.top + margin.bottom)
                          .append("g")
                          .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create the SVG container for inmate deaths
            const svg2 = d3.select("#chart2 svg")
                          .attr("width", width + margin.left + margin.right)
                          .attr("height", height + margin.top + margin.bottom)
                          .append("g")
                          .attr("transform", `translate(${margin.left},${margin.top})`);


            // Create the x scale with unique states
            const x1 = d3.scaleBand()
                        .domain(aggregatedCasesArray.map(d => d.facility_state))
                        .range([0, width])
                        .padding(0.1);
            const x2 = d3.scaleBand()
                        .domain(aggregatedDeathsArray.map(d => d.facility_state))
                        .range([0, width])
                        .padding(0.1);
                        

            // Create the y scale
            const y1 = d3.scaleLinear()
                        .domain([0, d3.max(aggregatedCasesArray, d => d.total_inmate_cases)])
                        .nice() // To round the domain values
                        .range([height, 0]);
            const y2 = d3.scaleLinear()
                       .domain([0, d3.max(aggregatedDeathsArray, d => d.total_inmate_deaths)])
                       .nice() // To round the domain values
                       .range([height, 0]);

            // Add the y axis to both charts
            svg1.append("g")
                .call(d3.axisLeft(y1));

            svg2.append("g")
                .call(d3.axisLeft(y2));

            // Add the y axis titles
            svg1.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .text("Total Inmate Cases");

            svg2.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .text("Total Inmate Deaths");

            // Add the x axis to both charts
            svg1.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x1).tickSize(0).tickFormat(''));

            svg2.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x2).tickSize(0).tickFormat(''));

            // Create bars for the first chart
            svg1.selectAll(".bar")
                .data(aggregatedCasesArray)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x1(d.facility_state))
                .attr("y", d => y1(d.total_inmate_cases))
                .attr("width", x1.bandwidth())
                .attr("height", d => height - y1(d.total_inmate_cases))
                .attr("fill", d => color(d.facility_state));

            // Create bars for the second chart
            svg2.selectAll(".bar")
                .data(aggregatedDeathsArray)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x2(d.facility_state))
                .attr("y", d => y2(d.total_inmate_deaths))
                .attr("width", x2.bandwidth())
                .attr("height", d => height - y2(d.total_inmate_deaths))
                .attr("fill", d => color(d.facility_state));

            // Add shared legend
            const svgLegend = d3.select("#legend svg");

            const legendItemWidth = 100; // Adjust this value based on the width you want for each legend item
            const itemsPerRow = Math.floor(1200 / legendItemWidth);

            const legend = svgLegend.selectAll(".legend")
                                    .data(color.domain())
                                    .enter().append("g")
                                    .attr("class", "legend")
                                    .attr("transform", (d, i) => {
                                        const x = (i % itemsPerRow) * legendItemWidth;
                                        const y = Math.floor(i / itemsPerRow) * 20; // 20 pixels height per row
                                        return `translate(${x}, ${y})`;
                                    });

            legend.append("rect")
                  .attr("width", 18)
                  .attr("height", 18)
                  .style("fill", color);

            legend.append("text")
                  .attr("x", 24)
                  .attr("y", 9)
                  .attr("dy", ".35em")
                  .style("text-anchor", "start")
                  .text(d => d);
        }

        init();
    </script>
</body>
</html>
