<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Narrative Visualization</title>
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- D3-Annotation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <!-- CSS Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #505143; /* Set font color */
            background-color: #9C9E84; /* Set background color */
        }
        #visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            width: 100%;
            margin: 0 auto;
            justify-items: center;
        }
        h1 {
            font-size: 50px; /* Increase font size */
            font-weight: bold; /* Make font bold */
            text-align: center; /* Center align the header */
        }
        .legend {
            font-size: 14px;
        }
        .legend-container {
            text-align: center;
            margin-top: 20px;
        }
        .button-container {
            text-align: center;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #505143; /* Set button background color to match header */
            color: white; /* Set button font color to white */
            border: none; /* Remove default border */
            border-radius: 5px; /* Optional: Add rounded corners */
        }
        button:hover {
            background-color: #7F815C; /* Optional: Add a hover effect */
        }
        .hidden {
            display: none;
        }
        .bar text {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }
        .bar text.vertical {
            transform: rotate(-90deg);
            transform-origin: middle;
            text-anchor: start;
        }
        #dropdown-menu {
            text-align: center;
            margin-top: 20px;
        }

        #view-selection {
            padding: 10px;
            font-size: 16px;
            background-color: #505143; /* Set background color for the dropdown */
            color: white; /* Set font color for the dropdown */
            border: none; /* Remove default border */
            border-radius: 5px; /* Optional: Add rounded corners */
        }
        select {
            padding: 10px;
            font-size: 16px;
        }
        .annotation-note {
            fill: black; /* Change text color here */
            font-size: 16px; /* Optional: Change font size */
            font-weight: bold; /* Optional: Change font weight */
        }
        .annotation-title {
            fill: black; /* Change title color here */
            font-weight: bold; /* Optional: Change font weight */
        }
        #footnote {
            font-size: 16px;
            color: #505143;
            text-align: right;
            margin: 10px;
            padding-right: 10px;
            position: fixed;
            right: 0;
            bottom: 0;
        }
        .caption {
            font-size: 16px;
            color: #505143;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Overview of Covid cases and deaths between March 2020 to March 2021 among inmates in federal prisons</h1>

    <div id="scene1">
        <div id="visualization">
            <div id="chart1">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart2">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div id="legend1" class="legend-container">
            <svg width="1400" height="200"></svg>
        </div>
        <div class="button-container">
            <button id="next1">Next</button>
        </div>
        <div class="caption">
            Data source: https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv
            Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <div id="scene2" class="hidden">
        <div id="visualization">
            <div id="chart3">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart4">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div class="button-container">
            <button id="previous2">Previous</button>
            <button id="next2">Next</button>
        </div>
        <div id="legend2" class="legend-container">
            <svg width="1200" height="100"></svg>
        </div>
        <div class="caption">
            Data source: https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv
            Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <div id="scene3" class="hidden">
        <div id="dropdown-menu">
            <label for="view-selection">Select States View: </label>
            <select id="view-selection">
                <option value="top5">Top 5 States</option>
                <option value="all">All States</option>
            </select>
        </div>
        <div id="visualization">
            <div id="chart5">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart6">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart7" class="additional-chart">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart8" class="additional-chart">
                <svg width="600" height="500"></svg>
            </div>
			<div id="chart9" class="additional-chart">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart10" class="additional-chart">
                <svg width="600" height="500"></svg>
            </div>
        </div>
<!--         <div id="legend3" class="legend-container">
            <svg width="1400" height="200"></svg>
        </div> -->
        <div class="button-container">
            <button id="previous3">Previous</button>
        </div>
        <div class="caption">
            Data source: https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv
            Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        let data;
       // const includeLabels = true; // Define this variable for conditional labels

        // Define `allStates` and `colorScale` globally
        
        //const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
async function init() {
    // Load the data
        // Define a color scale
    
    data = await d3.csv('./facilities.csv');

    const aggregatedCasesData = d3.rollup(
        data,
        v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per state
        d => d.facility_state
    );
    const aggregatedDeathsData = d3.rollup(
        data,
        v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate deaths per state
        d => d.facility_state
    );

    // Convert the Map to an array for easier handling in D3
    const aggregatedCasesArray = Array.from(aggregatedCasesData, ([facility_state, total_inmate_cases]) => ({facility_state, total_inmate_cases}));
    const aggregatedDeathsArray = Array.from(aggregatedDeathsData, ([facility_state, total_inmate_deaths]) => ({facility_state, total_inmate_deaths}));

    // Sort the aggregated array by total inmate cases and deaths in descending order
    aggregatedCasesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
    aggregatedDeathsArray.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);

    const top5CasesData = aggregatedCasesArray.slice(0, 5); // Get the top 5 states by total inmate cases
    const top5DeathsData = aggregatedDeathsArray.slice(0, 5); // Get the top 5 states by total inmate deaths

    const top5States = top5CasesData.map(d => d.facility_state); // Extract the state names from top 5 cases data
    const top5States2 = top5DeathsData.map(d => d.facility_state); // Extract the state names from top 5 cases data

    const top5CitiesDataByState = new Map();
    const top5CitiesDataByState2 = new Map();
	
	const allStates1 = aggregatedCasesArray.map(d => d.facility_state); // Extract the state names from all states cases data
    const allStates2 = aggregatedCasesArray.map(d => d.facility_state); // Extract the state names from all states 5 deaths data
	
	const AllCitiesDataByState = new Map();
    const AllCitiesDataByState2 = new Map();
	
    const allStates = new Set([
    ...aggregatedCasesArray.map(d => d.facility_state),
    ...aggregatedDeathsArray.map(d => d.facility_state),
]);
const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
.domain(Array.from(allStates));

    // Loop through the top 5 states and get the cities data for each state
    for (const state of top5States) {
        const citiesData = d3.rollup(
            data.filter(d => d.facility_state === state), // Filter data by state
            v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per city
            d => d.facility_city
        );
        const citiesArray = Array.from(citiesData, ([facility_city, total_inmate_cases]) => ({facility_city, total_inmate_cases}));
        // Sort the cities array by total inmate cases in descending order and get the top 5 cities
        citiesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
        const top5CitiesData = citiesArray.slice(0, 5);
        top5CitiesDataByState.set(state, top5CitiesData);
    }
        for (const state of top5States2) {
        const citiesData2 = d3.rollup(
            data.filter(d => d.facility_state === state), // Filter data by state
            v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate cases per city
            d => d.facility_city
        );        
        const citiesArray2 = Array.from(citiesData2, ([facility_city, total_inmate_deaths]) => ({facility_city, total_inmate_deaths}));
         // Sort the cities array by total inmate deaths in descending order and get the top 5 cities
        citiesArray2.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);
        const top5CitiesData2 = citiesArray2.slice(0, 5);        
        top5CitiesDataByState2.set(state, top5CitiesData2);
    }
for (const state of allStates1) {
        const AllcitiesData = d3.rollup(
            data.filter(d => d.facility_state === state), // Filter data by state
            v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per city
            d => d.facility_city
        );
        const AllcitiesArray = Array.from(AllcitiesData, ([facility_city, total_inmate_cases]) => ({facility_city, total_inmate_cases}));
        // Sort the cities array by total inmate cases in descending order and get the top 5 cities
        AllcitiesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
        //const AllCitiesData = AllcitiesArray.slice(0, 5);
        AllCitiesDataByState.set(state, AllcitiesArray);
    }
	
	for (const state of allStates2) {
        const AllcitiesData2 = d3.rollup(
            data.filter(d => d.facility_state === state), // Filter data by state
            v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per city
            d => d.facility_city
        );
        const AllcitiesArray2 = Array.from(AllcitiesData2, ([facility_city, total_inmate_cases]) => ({facility_city, total_inmate_cases}));
        // Sort the cities array by total inmate cases in descending order and get the top 5 cities
        AllcitiesArray2.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
        //const AllCitiesData = AllcitiesArray.slice(0, 5);
        AllCitiesDataByState2.set(state, AllcitiesArray2);
    }
	
	
    createBarChart('#chart1 svg', aggregatedCasesArray, 'facility_state', 'total_inmate_cases', 'Total Inmate Cases per State',colorScale,false);
    createBarChart('#chart2 svg', aggregatedDeathsArray, 'facility_state', 'total_inmate_deaths', 'Total Inmate Deaths per State',colorScale,false);
    createBarChart('#chart3 svg', top5CasesData, 'facility_state', 'total_inmate_cases', 'Top 5 States by Inmate Cases',colorScale,true);
    createBarChart('#chart4 svg', top5DeathsData, 'facility_state', 'total_inmate_deaths', 'Top 5 States by Inmate Deaths',colorScale,true);

    createLegend('#legend1 svg', aggregatedCasesArray.map(d => d.facility_state),colorScale);
    createLegend('#legend2 svg', top5CasesData.map(d => d.facility_state),colorScale);
    //createLegend('#legend3 svg', top5CasesData.map(d => d.facility_state),colorScale);

    const dropdown = d3.select('#view-selection');
    dropdown.on('change', () => {
        const selectedValue = dropdown.property('value');
        updateScene3(selectedValue, aggregatedCasesArray, aggregatedDeathsArray, top5CasesData, top5CitiesDataByState,top5DeathsData, top5CitiesDataByState2,AllCitiesDataByState,AllCitiesDataByState2,colorScale);
    });

    updateScene3(dropdown.property('value'), aggregatedCasesArray, aggregatedDeathsArray, top5CasesData, top5CitiesDataByState, top5DeathsData,top5CitiesDataByState2,AllCitiesDataByState,AllCitiesDataByState2,colorScale);
}

function createBarChart(selector, data, xField, yField, title, colorScale,showLabels = false) {
    const svg = d3.select(selector);
    const width = +svg.attr('width');
    const height = +svg.attr('height');
    const margin = {top: 40, right: 20, bottom: 100, left: 60};

    svg.selectAll('*').remove();

    const x = d3.scaleBand()
        .domain(data.map(d => d[xField]))
        .range([margin.left, width - margin.right])
        .padding(0.1);

    const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d[yField])]).nice()
        .range([height - margin.bottom, margin.top]);

    svg.append('g')
        .selectAll('rect')
        .data(data)
        .join('rect')
        .attr('x', d => x(d[xField]))
        .attr('y', d => y(d[yField]))
        .attr('height', d => y(0) - y(d[yField]))
        .attr('width', x.bandwidth())
        .attr('fill', d => colorScale(d[xField]))  // Use color scale
        .attr('class', 'bar');

    svg.append('g')
        .attr('transform', `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).tickFormat(() => ''));

    svg.append('g')
        .attr('transform', `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

    /*svg.append('text')
        .attr('x', width / 2)
        .attr('y', margin.top / 2)
        .attr('text-anchor', 'middle')
        .style('font-size', '16px')
        .text(title);*/

        if (showLabels){
        svg.append('g')
        .selectAll('text')
        .data(data)
        .join('text')
        .attr('x', d => x(d[xField]) + x.bandwidth() / 2) // Center text horizontally in the bar
        .attr('y', d => y(d[yField]) - 5) // Position text slightly above the top of the bar
        .attr('text-anchor', 'middle')
        .style('fill', 'black')
        .style('font-size', '12px')
        .text(d => d[xField]); // Display state names
        }
}

function createLegend(selector, states, colorScale) {
    const svg = d3.select(selector);
    const width = +svg.attr('width');
    const height = +svg.attr('height');
    const itemWidth = 150;
    const itemHeight = 30;
    const padding = 10;
    const itemsPerRow = Math.floor(width / itemWidth);

    svg.selectAll('*').remove();

    const legend = svg.selectAll('.legend')
        .data(states)
        .enter().append('g')
        .attr('class', 'legend')
        .attr('transform', (d, i) => {
            const x = (i % itemsPerRow) * itemWidth;
            const y = Math.floor(i / itemsPerRow) * itemHeight;
            return `translate(${x}, ${y})`;
        });

    legend.append('rect')
        .attr('x', 0)
        .attr('width', 18)
        .attr('height', 18)
        .style('fill', d => colorScale(d));

    legend.append('text')
        .attr('x', 24)
        .attr('y', 9)
        .attr('dy', '.35em')
        .style('text-anchor', 'start')
        .text(d => d);
}

function updateScene3(selectedView, aggregatedCasesArray, aggregatedDeathsArray, top5CasesData, top5CitiesDataByState, top5DeathsData, top5CitiesDataByState2, AllCitiesDataByState,AllCitiesDataByState2,colorScale) {
    if (selectedView === 'top5') {
        d3.select('#chart7').style('display', null);
        d3.select('#chart8').style('display', null);
		d3.select('#chart9').style('display', 'none');
        d3.select('#chart10').style('display', 'none');
        // Update charts for top 5 states
        createBarChart('#chart5 svg', top5CasesData, 'facility_state', 'total_inmate_cases', 'Top 5 States by Inmate Cases', colorScale,true);
        createBarChart('#chart6 svg', top5DeathsData, 'facility_state', 'total_inmate_deaths', 'Top 5 States by Inmate Deaths', colorScale,true); // Placeholder for chart6

        // Clear previous event handlers
        d3.selectAll('#chart5 svg .bar').on('click', null);

        // Handle state selection and display top 5 cities
        d3.selectAll('#chart5 svg .bar').on('click', (event, d) => {
            const state = d.facility_state;
            const top5CitiesData = top5CitiesDataByState.get(state);
            createBarChart('#chart7 svg', top5CitiesData, 'facility_city', 'total_inmate_cases', `Top 5 Cities in ${state} by Inmate Cases`, colorScale,true);
        });

        // Clear previous event handlers
        d3.selectAll('#chart6 svg .bar').on('click', null);

        // Handle state selection and display top 5 cities
        d3.selectAll('#chart6 svg .bar').on('click', (event, d) => {
            const state = d.facility_state;
            const top5CitiesData2 = top5CitiesDataByState2.get(state);
            createBarChart('#chart8 svg', top5CitiesData2, 'facility_city', 'total_inmate_deaths', `Total Inmate Deaths in Top 5 Cities of ${state}`, colorScale,true); // Placeholder for chart8
        });

        // Update legend for top 5 states
        //createLegend('#legend3 svg', top5CasesData.map(d => d.facility_state), colorScale);

    } else {
        d3.select('#chart7').style('display', 'none');
        d3.select('#chart8').style('display', 'none');
		d3.select('#chart9').style('display', null);
        d3.select('#chart10').style('display', null);
        // Update charts for all states
        createBarChart('#chart5 svg', aggregatedCasesArray, 'facility_state', 'total_inmate_cases', 'Total Inmate Cases per State', colorScale);
        createBarChart('#chart6 svg', aggregatedDeathsArray, 'facility_state', 'total_inmate_deaths', 'Total Inmate Deaths per State', colorScale); // Placeholder for chart6

        // Clear previous event handlers
        d3.selectAll('#chart5 svg .bar').on('click', null);
        d3.selectAll('#chart6 svg .bar').on('click', null);

		d3.selectAll('#chart5 svg .bar').on('click', (event, d) => {
            const state = d.facility_state;
            const AllCitiesData = AllCitiesDataByState.get(state);
            createBarChart('#chart9 svg', AllCitiesData, 'facility_city', 'total_inmate_cases', `All Cities in ${state} by Inmate Cases`, colorScale,true);
        });
		
		d3.selectAll('#chart6 svg .bar').on('click', (event, d) => {
            const state = d.facility_state;
            const AllCitiesData2 = AllCitiesDataByState2.get(state);
            createBarChart('#chart10 svg', AllCitiesData2, 'facility_city', 'total_inmate_cases', `All Cities in ${state} by Inmate Deaths`, colorScale,true);
        });
        // Update legend for all states
        //createLegend('#legend3 svg', aggregatedCasesArray.map(d => d.facility_state), colorScale);
    }
}


d3.select('#next1').on('click', () => {
    d3.select('#scene1').classed('hidden', true);
    d3.select('#scene2').classed('hidden', false);
});

d3.select('#previous2').on('click', () => {
    d3.select('#scene1').classed('hidden', false);
    d3.select('#scene2').classed('hidden', true);
});

d3.select('#next2').on('click', () => {
    d3.select('#scene2').classed('hidden', true);
    d3.select('#scene3').classed('hidden', false);
});

d3.select('#previous3').on('click', () => {
    d3.select('#scene2').classed('hidden', false);
    d3.select('#scene3').classed('hidden', true);
});

init();

    </script>
</body>
</html>
