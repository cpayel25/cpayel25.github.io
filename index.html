<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Narrative Visualization</title>
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- D3-Annotation Library -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
   
    <!-- CSS Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #505143; /* Set font color */
            background-color: #9C9E84; /* Set background color */
            padding-bottom: 50px; /* Ensure there is enough space at the bottom */
        }
        #visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            width: 100%;
            margin: 0 auto;
            justify-items: center;
        }
        #visualization svg {
    padding: 20px; /* Add padding to SVG containers */
}
        h1 {
            font-size: 40px; /* Increase font size */
            font-weight: bold; /* Make font bold */
            text-align: center; /* Center align the header */
        }
        p {
            font-size: 35x; /* Increase font size */
            font-weight: bold; /* Make font bold */
            text-align: center; /* Center align the header */
        }
        
        .legend {
            font-size: 14px;
        }
        .legend-container {
            text-align: center;
            margin-top: 20px;
        }
        .button-container {
            text-align: center;
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #505143; /* Set button background color to match header */
            color: white; /* Set button font color to white */
            border: none; /* Remove default border */
            border-radius: 5px; /* Optional: Add rounded corners */
        }
        button:hover {
            background-color: #7F815C; /* Optional: Add a hover effect */
        }
        .hidden {
            display: none;
        }
        .bar text {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }
        .bar text.vertical {
            transform: rotate(-90deg);
            transform-origin: middle;
            text-anchor: start;
        }
        #dropdown-menu {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #view-selection {
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
            background-color: #505143; /* Set background color for the dropdown */
            color: white; /* Set font color for the dropdown */
            border: none; /* Remove default border */
            border-radius: 5px; /* Optional: Add rounded corners */
        }
        select {
            padding: 10px;
            font-size: 16px;
        }
        .annotation-note {
            fill: black; /* Change text color here */
            font-size: 16px; /* Optional: Change font size */
            font-weight: bold; /* Optional: Change font weight */

        }
        .annotation-title {
            fill: black; /* Change title color here */
            font-weight: bold; /* Optional: Change font weight */
        }
        .connector {
      stroke: transparent;
      stroke-width: 1px;
    }
        #footnote {
            font-size: 16px;
            color: #505143;
            text-align: right;
            margin: 10px;
            padding-right: 10px;
            position: fixed;
            right: 0;
            bottom: 0;
            font-weight: bold;
        }
        .caption {
            font-size: 16px;
            color: #505143;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
        }
        .tooltip {
    position: absolute;
    text-align: center;
    width: auto;
    height: auto;
    padding: 5px;
    font: 12px sans-serif;
    background: lightgrey;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
    opacity: 0;
}
    </style>
</head>
<body>
    <h1>Narrative Visualization: Overview of Covid Cases & Deaths between March 2020 to March 2021 among inmates in federal prisons</h1>
    <p>This dashboard will help to understand the number of Covid cases and deaths in the centers described in caption below, across the country and analyze which state and which cities had the worst plight.</p>
    
    <div id="scene1">
        <div id="visualization">
            <div id="chart1">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart2">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div id="legend1" class="legend-container">
            <svg width="1400" height="200"></svg>
        </div>
        <div class="button-container">
            <button id="next1">Next</button>
        </div>
        <div class="caption">
            <a href="https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv">https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv</a><br>
            <b>Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.</b>
        </div>
            
            <!--This dashboard will help to understand the number of Covid cases and deaths in these centers across the country and analyze which state and which cities had the worst plight. -->
        
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <div id="scene2" class="hidden">
        <div id="visualization">
            <div id="chart3">
                <svg width="600" height="500"></svg>
            </div>
            <div id="chart4">
                <svg width="600" height="500"></svg>
            </div>
        </div>
        <div class="button-container">
            <button id="previous2">Previous</button>
            <button id="next2">Next</button>
        </div>
        <div id="legend2" class="legend-container">
            <svg width="1200" height="100"></svg>
        </div>
        <div class="caption">
            <a href="https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv">https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv</a><br>
            <b>Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.</b>
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
    </div>

    <div id="scene3" class="hidden">
        <div id="dropdown-menu">
            <label for="view-selection">Select Options to see top 5 states or all states: </label>
            <select id="view-selection">
                <option value="top5">Top 5 States</option>
                <option value="all">All States</option>
            </select>
        </div>
        <div id="visualization">
            <div id="chart5">
                <svg width="900" height="700"></svg>
            </div>
            <div id="chart6">
                <svg width="900" height="700"></svg>
            </div>
            <div id="chart7" class="additional-chart">
                <svg width="900" height="700"></svg>
            </div>
            <div id="chart8" class="additional-chart">
                <svg width="900" height="700"></svg>
            </div>
			<div id="chart9" class="additional-chart">
                <svg width="900" height="700"></svg>
            </div>
            <div id="chart10" class="additional-chart">
                <svg width="900" height="700"></svg>
            </div>
        </div>
        <div id="legend3" class="legend-container">
            <svg width="1500" height="300"></svg>
        </div> 
        <div class="button-container">
            <button id="previous3">Previous</button>
        </div>
        <div class="caption">
            <a href="https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv">https://github.com/nytimes/covid-19-data/tree/master/prisons/facilities.csv</a><br>
            <b>Data collected by The New York Times for state and federal prisons; immigration detention centers; juvenile detention facilities; local, regional and reservation jails; and those in the custody of the U.S. Marshals Service.</b>
        </div>
        <div id="footnote">
            Created by: Payel Chakraborty
        </div>
        <div id="tooltip" class="tooltip"></div>
    </div>

        <!-- JavaScript Code -->
        <script>
            let data;
        // const includeLabels = true; // Define this variable for conditional labels

            // Define `allStates` and `colorScale` globally
            
            //const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
    async function init() {
        // Load the data
            // Define a color scale
        
        data = await d3.csv('./facilities.csv');

        const aggregatedCasesData = d3.rollup(
            data,
            v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per state
            d => d.facility_state
        );
        const aggregatedDeathsData = d3.rollup(
            data,
            v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate deaths per state
            d => d.facility_state
        );

        // Convert the Map to an array for easier handling in D3
        const aggregatedCasesArray = Array.from(aggregatedCasesData, ([facility_state, total_inmate_cases]) => ({facility_state, total_inmate_cases}));
        const aggregatedDeathsArray = Array.from(aggregatedDeathsData, ([facility_state, total_inmate_deaths]) => ({facility_state, total_inmate_deaths}));

        // Sort the aggregated array by total inmate cases and deaths in descending order
        aggregatedCasesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
        aggregatedDeathsArray.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);

        const top5CasesData = aggregatedCasesArray.slice(0, 5); // Get the top 5 states by total inmate cases
        const top5DeathsData = aggregatedDeathsArray.slice(0, 5); // Get the top 5 states by total inmate deaths

        const top5States = top5CasesData.map(d => d.facility_state); // Extract the state names from top 5 cases data
        const top5States2 = top5DeathsData.map(d => d.facility_state); // Extract the state names from top 5 cases data

        const top5CitiesDataByState = new Map();
        const top5CitiesDataByState2 = new Map();
        
        // Calculate total cases and deaths
        const totalCases = d3.sum(aggregatedCasesArray, d => d.total_inmate_cases);
                    const totalDeaths = d3.sum(aggregatedDeathsArray, d => d.total_inmate_deaths);

                    // Calculate the total number of inmate cases in the top 5 states
        const totalTop5Cases = d3.sum(top5CasesData, d => d.total_inmate_cases);
        const totalTop5Deaths = d3.sum(top5DeathsData, d => d.total_inmate_deaths);

        const allStates1 = aggregatedCasesArray.map(d => d.facility_state); // Extract the state names from all states cases data
        const allStates2 = aggregatedCasesArray.map(d => d.facility_state); // Extract the state names from all states 5 deaths data
        
        const AllCitiesDataByState = new Map();
        const AllCitiesDataByState2 = new Map();
        
        const allStates = new Set([
        ...aggregatedCasesArray.map(d => d.facility_state),
        ...aggregatedDeathsArray.map(d => d.facility_state),
    ]);
    const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
    .domain(Array.from(allStates));

        // Loop through the top 5 states and get the cities data for each state
        for (const state of top5States) {
            const citiesData = d3.rollup(
                data.filter(d => d.facility_state === state), // Filter data by state
                v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per city
                d => d.facility_city
            );
            const citiesArray = Array.from(citiesData, ([facility_city, total_inmate_cases]) => ({facility_city, total_inmate_cases}));
            // Sort the cities array by total inmate cases in descending order and get the top 5 cities
            citiesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
            const top5CitiesData = citiesArray.slice(0, 5);
            top5CitiesDataByState.set(state, top5CitiesData);
            //const totaltop5cities = d3.sum(top5CitiesData, d => d.total_inmate_cases);
        }
            for (const state of top5States2) {
            const citiesData2 = d3.rollup(
                data.filter(d => d.facility_state === state), // Filter data by state
                v => d3.sum(v, d => +d.total_inmate_deaths), // Summing the total inmate cases per city
                d => d.facility_city
            );        
            const citiesArray2 = Array.from(citiesData2, ([facility_city, total_inmate_deaths]) => ({facility_city, total_inmate_deaths}));
            // Sort the cities array by total inmate deaths in descending order and get the top 5 cities
            citiesArray2.sort((a, b) => b.total_inmate_deaths - a.total_inmate_deaths);
            const top5CitiesData2 = citiesArray2.slice(0, 5);        
            top5CitiesDataByState2.set(state, top5CitiesData2);
            //const totaltop5cities2 = d3.sum(top5CitiesData2, d => d.total_inmate_cases);
        }
    for (const state of allStates1) {
            const AllcitiesData = d3.rollup(
                data.filter(d => d.facility_state === state), // Filter data by state
                v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per city
                d => d.facility_city
            );
            const AllcitiesArray = Array.from(AllcitiesData, ([facility_city, total_inmate_cases]) => ({facility_city, total_inmate_cases}));
            // Sort the cities array by total inmate cases in descending order and get the top 5 cities
            AllcitiesArray.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
            const AllCitiesData = AllcitiesArray.slice(0, 10);
            AllCitiesDataByState.set(state, AllCitiesData);
        }
        
        for (const state of allStates2) {
            const AllcitiesData2 = d3.rollup(
                data.filter(d => d.facility_state === state), // Filter data by state
                v => d3.sum(v, d => +d.total_inmate_cases), // Summing the total inmate cases per city
                d => d.facility_city
            );
            const AllcitiesArray2 = Array.from(AllcitiesData2, ([facility_city, total_inmate_cases]) => ({facility_city, total_inmate_cases}));
            // Sort the cities array by total inmate cases in descending order and get the top 5 cities
            AllcitiesArray2.sort((a, b) => b.total_inmate_cases - a.total_inmate_cases);
            const AllCitiesData2 = AllcitiesArray2.slice(0, 10);
            AllCitiesDataByState2.set(state, AllCitiesData2);
        }
        
        // Define annotations
        const annotationsCasesTop5 = top5CasesData.map(d => ({
            note: {
                //label: `${d.facility_state}: ${(d.total_inmate_cases / totalTop5Cases * 100).toFixed(2)}% of total inmate cases`
                //label: `Top 5 states with cases ${d.facility_state}` //$d.facility_state}
                label: `Top 5 states that contributed to \n ${((totalTop5Cases/ totalCases) * 100).toFixed(2)}% of total Covid inmate cases`
            },
            x: 350, // Adjust these values based on your data and chart dimensions
                            y: 100,
                            dy: -50,
                            dx: -50,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel,
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
            }
        }));
                
                    const annotationsDeathsTop5 = [
                        {
                            note: {
                                label: `Top 5 states that contributed to \n ${((totalTop5Deaths/ totalDeaths) * 100).toFixed(2)}% of total Covid inmate deaths`
                            },
                            x: 400, // Adjust these values based on your data and chart dimensions
                            y: 80,
                            dy: -50,
                            dx: -80,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel,
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
                }
                            
                        }
                    ];
                    const annotationsDeaths = [
                        {
                            note: {
                                label: `There were ${totalCases} cases and ${totalDeaths} deaths across all US states and facilities. So ${((totalDeaths/totalCases)*100).toFixed(2)}% cases leading to death.`
                            },
                            x: 150, // Adjust these values based on your data and chart dimensions
                            y: 250,
                            dy: -50,
                            dx: 50,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                            type: d3.annotationLabel, // Ensure this type is correct
                            /*x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
                            */connector: null
                }
                        }
                    ];

                    
        
        createBarChart('#chart1 svg', aggregatedCasesArray, 'facility_state', 'total_inmate_cases', 'Total Inmate Cases per State',colorScale,false);
        createBarChart('#chart2 svg', aggregatedDeathsArray, 'facility_state', 'total_inmate_deaths', 'Total Inmate Deaths per State',colorScale,false,annotationsDeaths);
        createBarChart('#chart3 svg', top5CasesData, 'facility_state', 'total_inmate_cases', 'Top 5 States by Inmate Cases',colorScale,true,annotationsCasesTop5);
        createBarChart('#chart4 svg', top5DeathsData, 'facility_state', 'total_inmate_deaths', 'Top 5 States by Inmate Deaths',colorScale,true,annotationsDeathsTop5);

        createLegend('#legend1 svg', aggregatedCasesArray.map(d => d.facility_state),colorScale);
        createLegend('#legend2 svg', top5CasesData.map(d => d.facility_state),colorScale);
        createLegend('#legend3 svg', aggregatedCasesArray.map(d => d.facility_state),colorScale);

        const dropdown = d3.select('#view-selection');
        dropdown.on('change', () => {
            const selectedValue = dropdown.property('value');
            updateScene3(selectedValue, aggregatedCasesArray, aggregatedDeathsArray, top5CasesData, top5CitiesDataByState,top5DeathsData, top5CitiesDataByState2,AllCitiesDataByState,AllCitiesDataByState2,colorScale);
        });

        updateScene3(dropdown.property('value'), aggregatedCasesArray, aggregatedDeathsArray, top5CasesData, top5CitiesDataByState, top5DeathsData,top5CitiesDataByState2,AllCitiesDataByState,AllCitiesDataByState2,colorScale);
    }

    function createBarChart(selector, data, xField, yField, title, colorScale,showLabels = false,annotations = [], barColor = null) {
        const svg = d3.select(selector);
        const width = +svg.attr('width');
        const height = +svg.attr('height');
        const margin = {top: 40, right: 20, bottom: 100, left: 60};

        svg.selectAll('*').remove();

        const x = d3.scaleBand()
            .domain(data.map(d => d[xField]))
            .range([margin.left, width - margin.right])
            .padding(0.1);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d[yField])]).nice()
            .range([height - margin.bottom, margin.top]);

            const tooltip = d3.select('#tooltip'); // Select tooltip div using D3
        svg.append('g')
            .selectAll('rect')
            .data(data)
            .join('rect')
            .attr('x', d => x(d[xField]))
            .attr('y', d => y(d[yField]))
            .attr('height', d => y(0) - y(d[yField]))
            .attr('width', x.bandwidth())
            .attr('fill', barColor ? barColor : d => colorScale(d[xField]))  // Use barColor if specified
            .attr('class', 'bar')
            .on('mouseover', function(event, d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html(d[xField])
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on('mouseout', function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

        svg.append('g')
            .attr('transform', `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x).tickFormat(() => ''));

        svg.append('g')
            .attr('transform', `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));

        svg.append('text')
            //.attr('x', width / 2      
            .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height/2.5)
                .attr('y', margin.left-62)
                .attr('dy', '1em')  // Optional: Adjust vertical alignment
                .attr('text-anchor', 'middle')
                .style('font-size', '16px')
                .text(title);

            if (showLabels){
            svg.append('g')
            .selectAll('text')
            .data(data)
            .join('text')
            .attr('x', d => x(d[xField]) + x.bandwidth() / 2) // Center text horizontally in the bar
            .attr('y', d => y(d[yField]) - 5) // Position text slightly above the top of the bar
            .attr('text-anchor', 'middle')
            .style('fill', 'black')
            .style('font-size', '12px')
            .text(d => d[xField]); // Display state names
            }
            //setTimeout(() =>{
            if (annotations.length > 0) {
            svg.selectAll('.annotation-group').remove();
            const multiLineAnnotations = createMultiLineAnnotations(annotations);
            const makeAnnotations = d3.annotation()
                .annotations(multiLineAnnotations)
                .type(d3.annotationLabel);
                

            svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);

            svg.selectAll(".annotation-note-label")
                .style("fill", "black") // Set fill color directly
                .style("font-size", "16px") // Ensure font size
                .style("font-weight", "bold"); // Ensure font weight

            svg.selectAll(".annotation-title-label")
                .style("fill", "black") // Set fill color directly
                .style("font-weight", "bold"); // Ensure font weight

        };
    }

    function createMultiLineAnnotations(annotations) {
        const multiLineAnnotations = annotations.map(annotation => {
            const lines = annotation.note.label.split('\n'); // Split the label by newline
            const labelX = annotation.x + 10; // X offset for the label
            const labelY = annotation.y - 10; // Y offset for the label

            return lines.map((line, index) => ({
                x: annotation.x,
                y: annotation.y,
                note: {
                    label: line,
                    align: "middle",
                    wrap: 200
                },
                dx: annotation.dx,
                dy: annotation.dy + index * 20, // Offset each line vertically
                subject: annotation.subject,
                type: annotation.type
            }));
        });

        return [].concat(...multiLineAnnotations); // Flatten the array of arrays
    }

    function createLegend(selector, states, colorScale) {
        const svg = d3.select(selector);
        const width = +svg.attr('width');
        const height = +svg.attr('height');
        const itemWidth = 150;
        const itemHeight = 30;
        const padding = 10;
        const itemsPerRow = Math.floor(width / itemWidth);

        svg.selectAll('*').remove();

        const legend = svg.selectAll('.legend')
            .data(states)
            .enter().append('g')
            .attr('class', 'legend')
            .attr('transform', (d, i) => {
                const x = (i % itemsPerRow) * itemWidth;
                const y = Math.floor(i / itemsPerRow) * itemHeight;
                return `translate(${x}, ${y})`;
            });

        legend.append('rect')
            .attr('x', 0)
            .attr('width', 18)
            .attr('height', 18)
            .style('fill', d => colorScale(d));

        legend.append('text')
            .attr('x', 24)
            .attr('y', 9)
            .attr('dy', '.35em')
            .style('text-anchor', 'start')
            .text(d => d);

            

            
    }

    function updateScene3(selectedView, aggregatedCasesArray, aggregatedDeathsArray, top5CasesData, top5CitiesDataByState, top5DeathsData, top5CitiesDataByState2, AllCitiesDataByState,AllCitiesDataByState2,colorScale,annotations=[]) {
        const scene3stateView = [
                        {
                            note: {
                                label: `Click on any of the top 5 state bars\n to see the top 5 cities\n and their total inmate cases down below.`,
                                //wrap: 200
                            },
                            x: 570, // Adjust these values based on your data and chart dimensions
                            y: 180,
                            dy: -50,
                            dx: -80,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel,
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
                }
                            
                        }
                    ];

                    const scene3stateView_All = [
                        {
                            note: {
                                label: `Click on\n a state bar(see tooltip)\n to see the top 10 cities \nand their total inmate cases down below.`,
                                wrap: 200
                            },
                            x: 370, // Adjust these values based on your data and chart dimensions
                            y: 150,
                            dy: -10,
                            dx: -80,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel,
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
                }
                            
                        }
                    ];    

                    const scene3stateView2 = [
                        {
                            note: {
                                label: `Click on \nany of these top 5 state bars \n to see the top 5 cities \n and their total inmate deaths down below.`
                            },
                            x: 650, // Adjust these values based on your data and chart dimensions
                            y: 180,
                            dy: -60,
                            dx: -80,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel,
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
                }
                            
                        }
                    ];


                    const scene3stateView_All2 = [
                        {
                            note: {
                                label: `Click on\na state bar(see tooltip)\n to see the top 10 cities\n and their total inmate deaths down below.`
                            },
                            x: 370, // Adjust these values based on your data and chart dimensions
                            y: 150,
                            dy: -10,
                            dx: -80,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel
                }
                            
                        }
                    ];   

                    /*const cityCases = [
                        {
                            note: {
                                label: `These top 5 cities contributed toin Click on any of these top 5 state bars \n to see the top 5 cities \n and their total inmate cases down below.`
                            },
                            x: 570, // Adjust these values based on your data and chart dimensions
                            y: 180,
                            dy: -50,
                            dx: -80,
                            //className: "annotation-note",  // Add custom class
                            //titleClassName: "annotation-title", // Add custom title class
                            //subject: { radius: 30 }
                            subject: { // Custom subject to hide the connector line
                    type: d3.annotationLabel,
                    x: 0, // Connector line start x-coordinate (can be set to 0 or omitted)
                            y: 0, // Connector line start y-coordinate (can be set to 0 or omitted)
                            dx: 0, // Connector line end x-coordinate (set to 0 or omit to hide line)
                            dy: 0  // Connector line end y-coordinate (set to 0 or omit to hide line)
                }
                            
                        }
                    ];*/
                    //d3.selectAll('.annotation-group').remove();
        if (selectedView === 'top5') {
            d3.select('#chart7').style('display', null);
            d3.select('#chart8').style('display', null);
            d3.select('#chart9').style('display', 'none');
            d3.select('#chart10').style('display', 'none');
            //d3.select("#chart9-annotation").style("display", "none");
            //d3.selectAll(".annotation").remove();
            // Update charts for top 5 states
            createBarChart('#chart5 svg', top5CasesData, 'facility_state', 'total_inmate_cases', 'Top 5 States by Inmate Cases', colorScale,true,scene3stateView);
            createBarChart('#chart6 svg', top5DeathsData, 'facility_state', 'total_inmate_deaths', 'Top 5 States by Inmate Deaths', colorScale,true,scene3stateView2); // Placeholder for chart6

            // Clear previous event handlers
            d3.selectAll('#chart5 svg .bar').on('click', null);
           // d3.select("#chart7").classed("hidden", false);
            // Handle state selection and display top 5 cities
            d3.selectAll('#chart5 svg .bar').on('click', (event, d) => {
                const state = d.facility_state;
                const stateColor = colorScale(state);
                const top5CitiesData = top5CitiesDataByState.get(state);
                createBarChart('#chart7 svg', top5CitiesData, 'facility_city', 'total_inmate_cases', `Top 5 Cities in ${state} by Inmate Cases`, colorScale,true,[],stateColor);
                
                const svg7 = d3.select("#chart7 svg");
                //svg7.selectAll(".annotation").remove();  // Clear existing annotations
                svg7.append("text")
    .attr("x", 250) // Adjust x position
    .attr("y", 70) // Adjust y position
    .attr("class", "annotation-group")
    .text("Note: The city with highest cases in California has a blank city name in the data source.")
    .style("font-size", "12px")
    .style("font-weight", "bold")
    .style("fill", "black")
    .raise()
    //.setTimeout(500);
            });

            // Clear previous event handlers
            d3.selectAll('#chart6 svg .bar').on('click', null);

            // Handle state selection and display top 5 cities
            d3.selectAll('#chart6 svg .bar').on('click', (event, d) => {
                const state = d.facility_state;
                const stateColor = colorScale(state);
                const top5CitiesData2 = top5CitiesDataByState2.get(state);
                createBarChart('#chart8 svg', top5CitiesData2, 'facility_city', 'total_inmate_deaths', `Total Inmate Deaths in Top 5 Cities of ${state}`, colorScale,true,[],stateColor); // Placeholder for chart8
            });
           
            // Update legend for top 5 states
            //createLegend('#legend3 svg', top5CasesData.map(d => d.facility_state), colorScale);
            d3.select('#legend3 svg').style('display', 'none');

        } else {
            d3.select('#chart7').style('display', 'none');
            d3.select('#chart8').style('display', 'none');
            d3.select('#chart9').style('display', null);
            d3.select('#chart10').style('display', null);
            //d3.select("#chart7-annotation").style("display", "none");
           // d3.selectAll(".annotation").remove();
            // Update charts for all states
            createBarChart('#chart5 svg', aggregatedCasesArray, 'facility_state', 'total_inmate_cases', 'Total Inmate Cases per State', colorScale,false,scene3stateView_All);
            createBarChart('#chart6 svg', aggregatedDeathsArray, 'facility_state', 'total_inmate_deaths', 'Total Inmate Deaths per State', colorScale,false,scene3stateView_All2); // Placeholder for chart6

            // Clear previous event handlers
            d3.selectAll('#chart5 svg .bar').on('click', null);
            d3.selectAll('#chart6 svg .bar').on('click', null);
            //d3.select("#chart7").classed("hidden", true);
            d3.selectAll('#chart5 svg .bar').on('click', (event, d) => {
                const state = d.facility_state;
                const stateColor = colorScale(state);
                const AllCitiesData = AllCitiesDataByState.get(state);
                createBarChart('#chart9 svg', AllCitiesData, 'facility_city', 'total_inmate_cases', `All Cities in ${state} by Inmate Cases`, colorScale,true,[],stateColor);
            
            const svg9 = d3.select("#chart9 svg");
            //svg9.selectAll(".annotation").remove();  // Clear existing annotations
            
                svg9.append("text")
    .attr("x", 250) // Adjust x position
    .attr("y", 70) // Adjust y position
    .attr("class", "annotation-group")
    .text("Note: The city with highest cases in California has a blank city name in the data source.")
    .style("font-size", "12px")
    .style("font-weight", "bold")
    .style("fill", "black")
    .raise()
    //.setTimeout(500); 
});  
            d3.selectAll('#chart6 svg .bar').on('click', (event, d) => {
                const state = d.facility_state;
                const stateColor = colorScale(state);
                const AllCitiesData2 = AllCitiesDataByState2.get(state);
                createBarChart('#chart10 svg', AllCitiesData2, 'facility_city', 'total_inmate_cases', `All Cities in ${state} by Inmate Deaths`, colorScale,true,[],stateColor);
            });
            // Update legend for all states
            d3.select('#legend3 svg').style('display', null);
            createLegend('#legend3 svg', aggregatedCasesArray.map(d => d.facility_state), colorScale);
        }
    }


    d3.select('#next1').on('click', () => {
        d3.select('#scene1').classed('hidden', true);
        d3.select('#scene2').classed('hidden', false);
    });

    d3.select('#previous2').on('click', () => {
        d3.select('#scene1').classed('hidden', false);
        d3.select('#scene2').classed('hidden', true);
    });

    d3.select('#next2').on('click', () => {
        d3.select('#scene2').classed('hidden', true);
        d3.select('#scene3').classed('hidden', false);
    });

    d3.select('#previous3').on('click', () => {
        d3.select('#scene2').classed('hidden', false);
        d3.select('#scene3').classed('hidden', true);
    });

    init();

        </script>
    </body>
    </html>
